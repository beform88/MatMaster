from typing import Any, Mapping


def get_report_instruction(plan: Mapping[str, Any]) -> str:
    """Return an instruction prompt to generate a self-contained markdown report."""

    return f"""

请基于“完整上下文”（包括此前对话历史、工具调用结果/输出、上传/下载文件信息、以及 plan 内容）生成一份可直接保存的 Markdown 报告。

ROLE: expert Technical Writer

TASK: Analyze topic and collected facts, then rewrite the report based on collected facts only. Use facts from context, not your own knowledge.

硬性要求：
- 只输出 Markdown（不要输出多余解释、不要输出 JSON）。
- 文档必须自包含：读者不需要回看聊天记录也能理解发生了什么。
- 优先引用“已发生”的事实（工具输出、已确认的参数、已生成的结果）；不确定的内容必须明确标注为“假设/推测”。
- **如果上下文中已经存在成段的调研/分析/描述性回答（包括但不限于前面 `analysis_agent` 的总结、人工/模型的调研分析段落）**：在报告中应 **直接摘录原文**（可用引用块 `>`），必要时仅做轻量排版与小标题整理；不要重新“改写一遍”导致信息漂移或遗漏。
- “结论与建议”仅写上下文中已经明确要求的下一步；否则不要新增“可选下一步/建议下一步”。
- 缺失信息不显示，不要编造（尤其不要编造 URL、文件名、数值）。
- 先判断上下文主要语言（中文/英文）；报告必须使用相同语言输出（包括各级标题、字段名、表格表头）。

请严格按以下结构输出（与截图模板一致），并保证层级与编号不乱：

# 报告

**问题**：<用户问题（原文，尽量完整）>

（仅当上下文明确出现用户输入文件时，才显示“用户输入文件：...”这一行；否则不要显示该行）

（仅当上下文明确出现执行时间时，才显示“执行时间：...”这一行；否则不要显示该行）

**执行概况**：<成功/异常（若异常，简述异常类型与影响）>

---

## 1. 报告摘要
用 3-6 句话概述任务执行情况、关键计算/检索结果、以及任务完成情况（完成情况加粗）。

## 2. 方法与参数
说明采用什么步骤来求解/调用什么工具；并把工具与关键参数整理成表格（必须输出表格）。

表格要求：
- 以 plan 的步骤顺序为主（Step 1/2/3...）。
- 每行至少包含：步骤、工具名、用途、关键参数（只列关键字段）、产出/状态（success/failed/submitted/process）。
- “关键参数”不要塞大段 JSON，可用 `key=value` 形式并用 `;` 分隔。
- 不要出现代码块
- 表格表头语言必须与报告语言一致（中文/英文）。

示例表头（请按此输出）：
| Step | Tool | Purpose | Key Params | Output / Status |
|---|---|---|---|---|

## 3. 结果与分析
说明产出了哪些内容：有哪些图/表/文件/关键数值结论。

如果上下文里已经有“现成信息内容”，必须优先引用并直接复用，来源包括但不限于：
- `search-papers-enhanced`的结果
- `web_search` 的结果
- `extract_info_from_webpage`（或类似网页抽取工具）的结果
- `llm_tool`的结果
- 任何工具输出中的描述性要点/结论段落


不要把所有信息合并成一个“摘要”。你必须按“每一次工具调用/每一段独立资料来源”拆分成多个 ### 3.x 段落，其中 x 从 1 开始递增。

对3.x 段落的硬性要求：
- 以时间顺序列出（从早到晚）。
- **每个子 段落 必须有一个“内容驱动”的名字**：优先使用来源标题（网页标题/论文标题）；其次使用查询主题；再不行用一句话概括该子 段落 的主题。禁止使用泛化名字（如“上下文”“调研”“摘要”“资料”）。
- 每个子 段落 都必须尽量“原文完整复用”：把该次工具返回的主要内容按原文粘贴到报告里，不要改写为总结性摘要。
- 不要压缩成几句话的概述；除非上下文返回内容本身就很短。
- 每个子 段落 都必须标注来源：URL / 标题 / 工具名 / 查询词（如果有）。
- 不要出现代码块。

子 段落 模板（每一次工具调用都按此输出一份）：

### 3.x <子 段落 名字>
- <复制内容>

## 4. 结论与建议
总结上面结果，给出结论；如果用户在上下文里明确要求下一步方案/建议，再给出对应建议，否则只写结论即可。

## 5. 输出文件
把输出文件单独放在本节（必须输出表格；表头语言与报告语言一致）。

要求：
- 仅列出上下文中真实出现过的文件与链接（包括最终上传的报告 md 的 OSS URL）。
- 每行至少包含：类别、文件名、简要说明、URL/路径。

示例表头（请按此输出）：
| Category | File | Description | URL/Path |
|---|---|---|---|

## 6. 引用文献
把引用文献单独放在本节（不要用表格），放在“结论与建议”之后、“输出文件”之后。

要求：
- 仅收录上下文中真实出现并被使用过的来源（例如 web_search/网页抽取得到的 URL、论文信息等）。
- 使用标准引用格式（选择一种并保持一致：APA / IEEE / GB/T 7714 均可）。
- 每条引用后追加 1 句简单描述，说明它支持了报告中的哪条事实/结论。

<Plan Content>
{plan}

（提示：你可以从对话/工具输出中抽取“用户输入文件”“执行时间”“执行概况”等信息；无法确定就用“-”。）

""".strip()
